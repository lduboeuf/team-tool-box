<div>

  <form>
      <label for="team-list">select right group:</label>
      <select class="team-list" name="team-list">
        <option value="-1" selected="selected"></option>
        {{ for(var prop in it) { }}
          <option value="{{=it[prop].id}}">{{=it[prop].name}} ({{=it[prop].members.length}})</option>
        {{ } }}
        <option value="-1">--all groups--</option>
      </select>

  </form>
  <div class="teams-result">
    {{ for(var prop in it) { }}
    <div class="team">
      <h3>{{=it[prop].name}}<input type="checkbox" name="tick_all"></input></h3>
      <ul class="list" >
        {{~it[prop].members :member:idxm}}
          <li><label><input type="checkbox" name="member_name" value="{{=member.name}}"></input><span>{{=member.name}}</span></label></li>
        {{~}}
      </ul>
    </div>
    {{ } }}
    <div>
      <button class="btn-default">match</button>
    </div>
  </div>

<script type="text/javascript">

app.page("tool-match2", function()
{

  var $section = document.getElementById('tool-match2');
  var $selectTeamList = $section.querySelector('.team-list');
  var $teamList = $section.querySelector('.teams-result');

  //store template definition
  var tplSelectTeamList = doT.template($selectTeamList.innerHTML);
  var tplTeamList = doT.template($teamList.innerHTML);


  //empty tpl by default
  $selectTeamList.innerHTML =  '<option value="-1" selected="selected"></option>';
  $teamList.innerHTML = null;

  var selectedMembers = {};

  var displayTeams =function(teams){
    $teamList.innerHTML =  tplTeamList(teams);
    var $checkbox_members = $teamList.querySelectorAll('input[name="member_name"]');
    //handle tick all
    $teamList.querySelector('input[name="tick_all"]').onclick = function(){
      var checked = this.checked;
      for (var i=0; i < $checkbox_members.length; i++){
        $checkbox_members[i].checked = checked;
      }
    }

    $section.querySelector('button').onclick = function(e){

      selectedMembers.right = getSelectedMembers();
      app('tool-match3', selectedMembers);

    }

    //handle already selected members from left
    var leftMembers = selectedMembers.left;
    for (var i=0; i < leftMembers.length; i++){
      if (leftMembers.includes($checkbox_members[i].value)){
        $checkbox_members[i].parentNode.style='text-decoration:line-through';
        $checkbox_members[i].disabled = true;
      }
    }

  }

  var fetchMembers = function(teamId){
    if (teamId==-1){

      remoteStorage.teams.findAll().then(function(teams){
        displayTeams(teams);
        }
      );


    }else{
      remoteStorage.teams.find(teamId).then(
        function(team){
          var teams = {};
          teams[teamId] = team;
          displayTeams(teams);
        }
      );
    }
  }

  $selectTeamList.onchange = function(e){
    fetchMembers(this.value);
  }

  var getSelectedMembers = function($){
    var $checkbox_members = $teamList.querySelectorAll('input[name="member_name"]');
    var members = [];
    for (var i=0; i < $checkbox_members.length; i++){
      if ($checkbox_members[i].checked){
        members.push($checkbox_members[i].value);
      }
    }
    return members;
  }



  return function(params) {

    if (!params){
      app('tool-match');
      return;
    }

    selectedMembers.left = params;

    remoteStorage.teams.findAll().then(
      function(teams){

        if (Object.keys(teams).length === 0){
          app.alert('alert-info','humm, no members found, you can add members by clicking on the "My Groups" menu');
        }
        $selectTeamList.innerHTML = tplSelectTeamList(teams);
      }
    );


  }
});
//# sourceURL=tool-match2.js
</script>
</div>
